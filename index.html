<!DOCTYPE html>
<html>
 <head>
  <meta charset="UTF-8">
  <title>Hashtags</title>
  <link rel="stylesheet" href="stylesheet.css" charset="utf-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
 </head>
 <body>
   <header id="nav">
      <h1 id="logo">#hashTags</h1>
      <div id="login-status"></div>
   </header>
   <div id="form"></div>
   <div id="content"></div>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
   <script src="vendor/react.min.js"></script>
   <script src="vendor/JSXTransformer.js"></script>
   <script src="js/hashtag_form.js"></script>
   <script type="text/jsx">
     var parseResponse = function(response, tag, start, end) {
       var dataToReturn = []
       response.data.forEach(function(datum) {
         if (datum.caption && datum.caption.text.indexOf(tag) > -1) {
           var createdTime = datum.caption.created_time;
         } else {
           for(var i = 0; i < datum.comments.data.length; i++) {
             if (datum.comments.data[i].text.indexOf(tag) > -1) {
               var createdTime = datum.comments.data[i].created_time;
               break
             }
           }
         }
         if ((new Date(start) < createdTime * 1000) &&
              (new Date(end) > createdTime * 1000)) {
           if (datum.type == "image") {
             var path = datum.images.low_resolution.url
           } else {
             var path = datum.videos.low_bandwidth.url
           }
           dataToReturn.push({
             username: datum.user.username,
             type: datum.type,
             createdAt: createdTime,
             url: path,
             nativeUrl: datum.link
           })
         }
       }.bind(this))
       return dataToReturn;
     }

     var SignIn = React.createClass({
       handleClick: function() {
         window.location.replace(
           "https://instagram.com/oauth/authorize/?client_id=2ee58976c7a74d048636a229f797047c&redirect_uri=http://josefdaly.github.io/hashtags/&response_type=token"
         )
       },
       render: function() {
         return (
           <img onClick={this.handleClick} className="instagram-button"
             src="http://www.pictacular.co/img/Instagram_normal.png"
               alt="Instagram login" />
         )
       }
     })

     var ImageItem = React.createClass({
       render: function() {
         var date = new Date(this.props.createdAt * 1000)
         var formattedDate = date.toString();
         return (
           <li>
            <h3>{this.props.username}</h3>
            <span>{formattedDate}</span> <br/>
            <a href={this.props.nativeUrl}>View at Instagram</a> <br/>
            <img src={this.props.url} alt=""
              height="300" width="300"/>
           </li>
         )
       }
     })

     var VideoItem = React.createClass({
       render: function() {
         var date = new Date(this.props.createdAt * 1000)
         var formattedDate = date.toString();
         return (
           <li>
             <h3>{this.props.username}</h3>
             <span>{formattedDate}</span> <br/>
             <a href={this.props.nativeUrl}>View at Instagram</a> <br/>
             <video height="300" width="300" controls>
               <source src={this.props.url} type="video/mp4" />
             </video>
           </li>
         )
       }
     })

     var MediaIndex = React.createClass({
       nestedAjax: function(url) {
         $.ajax({
           url: url,
           dataType: 'JSON',
           crossDomain: true,
           success: function(response) {
             var newData = parseResponse(response, tag, start, end)
             var nextUrl = response.pagination.next_url
             this.setState({ data: this.state.data.concat(newData) })
             if (nextUrl) {
               this.nestedAjax(nextUrl, this.props.tag, this.props.start, this.props.end);
             }
           }.bind(this),
           error: function(response) {
             console.log(response)
             debugger
           }.bind(this)
         })
       },
       componentDidMount: function() {
         var url = "https://api.instagram.com/v1/tags/" + this.props.tag + "/media/recent?access_token=" + this.props.authToken;
         this.nextedAjax(url)
        //  $.ajax({
        //    url: "https://api.instagram.com/v1/tags/" + this.props.tag + "/media/recent?access_token=" + this.props.authToken,
        //    dataType: 'JSON',
        //    crossDomain: true,
        //    success: function(response) {
        //      var newData = parseResponse(response, this.props.tag, this.props.start, this.props.end)
        //      var nextUrl = response.pagination.next_url
        //      this.setState({ data: this.state.data.concat(newData) })
        //      if (nextUrl) {
        //        this.nestedAjax(nextUrl, this.props.tag, this.props.start, this.props.end)
        //      }
        //    }.bind(this),
        //    error: function(response) {
        //      console.log(response)
        //      debugger
        //    }.bind(this)
        //  })
       },
       getInitialState: function() {
         return ({data: []});
       },
       render: function() {
         if (this.state.data.length > 0) {
           var Media = []
           this.state.data.forEach(function(datum) {
             debugger
             if (datum.type == "image") {
               Media.push(

                   <ImageItem username={datum.username}
                     createdAt={datum.createdAt}
                       nativeUrl={datum.nativeUrl}
                         url={datum.url} />

               )
             } else if (datum.type == "video") {
               Media.push(

                   <VideoItem username={datum.username}
                     createdAt={datum.createdAt}
                       nativeUrl={datum.nativeUrl}
                         url={datum.url} />

               )
             }
           })
           return (
             <ul>
               {Media}
             </ul>
           )
         } else {
           return (
             <img className="center-block" src="images/ajax-loader.gif" alt="loading" />
           )
         }
       }
     })

     var HashTagForm = React.createClass({
       handleClick: function() {
         var input = $('#hashtag-input').val();
         var startDate = $('#start-date').val();
         var endDate = $('#end-date').val();
         $('#hashtag-input').val("");
         $('#start-date').val("");
         $('#end-date').val("");
         if (input == "" || startDate == "" || endDate == "") {
           alert('Must complete all feilds!')
         } else {
           React.unmountComponentAtNode(document.getElementById('content'));
           React.render(
             <MediaIndex authToken={this.props.token}
               tag={input} start={startDate} end={endDate} />,
             document.getElementById('content')
           )
         }
       },
       render: function() {
         return (
           <div className="hashtag-form center-block">
             <span>Hashtag: </span>
             <input className="total-width" id="hashtag-input" type="text" />
             <br/>
             <span>Start Date: </span>
             <input className="total-width" id="start-date" type="date" />
             <br/>
             <span>End Date: </span>
             <input className="total-width" id="end-date" type="date" />
             <br/>
             <button onClick={this.handleClick}
               className="btn btn-default center-block">Load Content!</button>
           </div>
         )
       }
     });

     if (location.hash == "") {
       React.render(
         <SignIn />,
         document.getElementById('login-status')
       )
     } else {
       var authToken = location.hash.slice(14)
       $.ajax({
         url: "https://api.instagram.com/v1/users/self?access_token=" + authToken,
         dataType: "JSON",
         crossDomain: true,
         success: function(response) {
           var userInfo = response.data
           $('#login-status').html('<span>Hi ' + userInfo.full_name + '</span>');
           React.render(<HashTagForm token={authToken} />, document.getElementById('form'))
         }.bind(this),
         error: function() {

         }.bind(this)
       })
     }
   </script>
 </body>
</html>
